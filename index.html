<html>

<head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>Imagetorio</title>
    <style type='text/css'>
        body {
            font-family: sans-serif;
        }

        .itemCheckboxGroup {
            width: 250px;
            display: inline-block;
            padding: 0px 5px
        }

        .preview {
            border: 1px solid rgb(97, 97, 97);
        }

        .colorBox {
            width: 15px;
            height: 15px;
            float: left
        }

        .countBox {
            float: right;
            font-weight: bold;
        }

        #blueprint {
            border: 2px solid rgb(235, 235, 235);
            background: rgb(95, 95, 146);
            color: white;
            min-width: 2cm;
            min-height: 1cm;
            max-width: 5cm;
            margin: 5px;
            padding: 2px;
            overflow: hidden;
        }
    </style>

    <script type="text/javascript" src="printer.js"></script>
    <script type="text/javascript" src="colors.js"></script>
    <script type="text/javascript" src="pako.js"></script>
    <script type="text/javascript" src="dither.js"></script>
    <script type='text/javascript'>

        var idx, printerSize;

        function getSize(img) {
            var wMax = document.getElementById("winput").value
            var hMax = document.getElementById("hinput").value

            hRatio = wMax / img.width;
            vRatio = hMax / img.height;

            var h, w;

            if (vRatio < hRatio) {
                w = Math.ceil(img.width * vRatio);
                h = hMax;
            }
            else {
                w = wMax;
                h = Math.ceil(img.height * hRatio);
            }

            if (isVertical()) {
                w *= 2
                h *= 4
            } else {
                w *= 4
                h *= 2
            }
            return [w, h]
        }

        function loadImage() {
            var input, file, fr, img;

            input = document.getElementById('imgfile');

            file = input.files[0];
            fr = new FileReader();
            fr.onload = createImage;
            fr.readAsDataURL(file);

            function createImage() {
                img = new Image();
                img.onload = imageLoaded;
                img.src = fr.result;
            }

            function drawDithered(imagedata, ctx, width, height) {
                var tempCanvas = document.createElement("canvas");
                var tempCtx = tempCanvas.getContext("2d");

                tempCanvas.width = imagedata.width;
                tempCanvas.height = imagedata.height;

                tempCtx.putImageData(imagedata, 0, 0);

                var img = new Image();
                img.onload = function () {
                    ctx.imageSmoothingEnabled = false
                    ctx.drawImage(img, 0, 0, width, height);
                }
                img.src = tempCanvas.toDataURL();
            }

            function imageLoaded() {
                var canvas = document.getElementById("canvas1")
                var canvas2 = document.getElementById("canvas2");

                canvas.width = img.width;
                canvas.height = img.height;
                canvas2.width = img.width;
                canvas2.height = img.height;

                var ctx = canvas.getContext("2d");
                var ctx2 = canvas2.getContext('2d');

                [w, h] = getSize(img)

                var imgd = resize(img, w, h)
                var pix = imgd.data;

                idx = dither(pix, w, h, getPalette());
                printerSize = w

                drawDithered(imgd, ctx2, img.width, img.height)

                ctx.drawImage(img, 0, 0);

                updateRequirements(idx)
            }

            function resize(img, width, height) {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');

                canvas.height = height;
                canvas.width = width;

                ctx.drawImage(img, 0, 0, width, height);

                return ctx.getImageData(0, 0, width, height);
            }
        }

        function getBlueprint() {
            document.getElementById("blueprint").innerHTML = makePrinter(idx, printerSize, direction(), getNames())
        }

        function direction() {
            return document.querySelector('input[name="direction"]:checked').value;
        }

        function isVertical() {
            var v = direction();
            return v == 'n' || v == 's'
        }

        function getPalette() {
            var palette = [];

            for (var item in colors) {
                if (colors.hasOwnProperty(item)) {
                    var checkbox = document.getElementById(item + 'Checkbox')

                    if (checkbox.checked) {
                        palette.push(colors[item])
                    }
                }
            }

            return palette;
        }

        function getNames() {
            var names = [];

            for (var item in colors) {
                if (colors.hasOwnProperty(item)) {
                    var checkbox = document.getElementById(item + 'Checkbox')

                    if (checkbox.checked) {
                        names.push(item)
                    }
                }
            }

            return names;
        }

        Object.defineProperties(Array.prototype, {
            count: {
                value: function (query) {
                    var count = 0;
                    for (let i = 0; i < this.length; i++)
                        if (this[i] == query)
                            count++;
                    return count;
                }
            }
        });

        function updateRequirements(idx) {
            for (var name in colors) {
                var out = document.getElementById(name + 'Count');
                out.value = ''
            }

            var names = getNames()

            for (var i = 0; i < names.length; i++) {
                var name = names[i]
                count = idx.count(i)
                var out = document.getElementById(name + 'Count');
                if (count > 0)
                    out.value = count;
            }
        }

        function readableName(name) {
            var name = name
                .replace('logistic-chest', 'logistic')
                .replace('defense', '')
                .replace(/-/g, ' ')

            return name[0].toUpperCase() + name.substr(1)
        }

        function init() {
            var cbh = document.getElementById('availableItems');
            for (var name in colors) {

                var div = document.createElement('div');
                div.className = 'itemCheckboxGroup';

                var colorBox = document.createElement('div')
                colorBox.className = 'colorBox'
                var [r, g, b] = colors[name]
                colorBox.style.backgroundColor = 'rgb(' + r + ',' + g + ',' + b + ')'
                div.appendChild(colorBox)

                var cb = document.createElement('input');
                cb.type = 'checkbox';
                div.appendChild(cb);
                cb.id = name + 'Checkbox';
                cb.name = name;
                cb.checked = true;
                cb.onchange = loadImage;

                var label = document.createElement('label')
                label.for = name
                label.textContent = readableName(name)
                div.appendChild(label)

                var count = document.createElement('output')
                count.id = name + 'Count';
                count.className = 'countBox'
                div.appendChild(count)

                cbh.appendChild(div)
            }
        }


    </script>
</head>

<body onload="init()">
    <h1>Imagetorio</h1>

    <canvas id="canvas1" class="preview"></canvas>
    <canvas id="canvas2" class="preview"></canvas>
    <br><br>

    <input type='file' id='imgfile' onchange='loadImage()' />
    <br><br>

    <div id="blueprint"></div>
    <button type="blueprintButton" onclick="getBlueprint()">Get blueprint</button>
    <br><br>

    <label for="hinput">Max height</label>
    <input type="number" id='hinput' min=1 max=1000 value=25 onchange='loadImage()'>

    <label for="winput">Max width</label>
    <input type="number" id='winput' min=1 max=1000 value=25 onchange='loadImage()'>
    <br><br>

    <label for="direction">Printer direction</label><br>
    <input type="radio" name="direction" value="n" onchange='loadImage()'> North
    <input type="radio" name="direction" value="e" onchange='loadImage()' checked=true> East
    <input type="radio" name="direction" value="w" onchange='loadImage()'> West
    <input type="radio" name="direction" value="s" onchange='loadImage()'> South
    <br><br>

    <form action='#' onsubmit="return false;" id='availableItems'>
    </form>

</body>